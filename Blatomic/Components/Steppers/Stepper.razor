<CascadingValue Value="this">
    <div class="flex items-start justify-around bg-gray-100 p-4">
        @for (var i = 0; i < steps.Count; i++)
        {
            var stepCount = i;
            <a class="shrink-0 flex-initial flex flex-col items-center cursor-pointer relative" @onclick="@(() => GoToStep(stepCount))">
                <div class="rounded-full z-10 h-8 w-8 p-1 text-center align-middle transition duration-500 @(i <= currentStepIndex ? "bg-green-300" : "bg-gray-200")">@(i + 1)</div>
                <div>@steps[i].Title</div>
                @if (i > 0)
                {
                    <div class="absolute left-0 w-1/2 mt-3">
                        <div class="w-full h-1 pointer-events-none transition duration-1000 @(i <= currentStepIndex ? "bg-green-300" : "bg-gray-200")"></div>
                    </div>
                }
                @if (i < steps.Count - 1)
                {
                    <div class="absolute right-0 w-1/2 mt-3">
                        <div class="w-full h-1 pointer-events-none transition duration-1000 @(currentStepIndex > i ? "bg-green-300" : "bg-gray-200")"></div>
                    </div>
                }
            </a>
            @if (i < steps.Count - 1)
            {
                <div class="w-full border-2 mt-3 transition duration-1000  @(i < currentStepIndex ? "border-green-300" : "border-gray-200")"></div>
            }
        }
    </div>
    <div>
        @ContentArea
        @ChildContent
    </div>
    <div class="flex @buttonJustify items-center bg-gray-100 p-4">
        @if (currentStepIndex != 0)
        {
            <div class="justify-self-start">
                <Button OnClickedAsync="PreviousStep"
                    RoundedStyle="RoundedStyle.XL">
                    Previous
                </Button>
            </div>
        }
        @if (currentStepIndex != steps.Count - 1)
        {
            <div class="justify-self-end">
                <Button OnClickedAsync="@(() => NextStep())"
                    RoundedStyle="RoundedStyle.XL"
                    IsDisabled="!IsStepComplete">
                    Next
                </Button>
            </div>
        }
    </div>
</CascadingValue>

@code {
    [Parameter] public string ButtonColors { get; set; } = "bg-indigo-500 hover:bg-indigo-400";
    [Parameter] public RenderFragment? ChildContent { get; set; }

    private string buttonJustify => currentStepIndex == 0 ? "justify-end" : "justify-between";
    private int currentStepIndex = 0;
    private List<Step> steps = new();
    private RenderFragment? ContentArea { get; set; }
    private bool IsStepComplete => steps == null || currentStepIndex >= steps.Count ? false : steps[currentStepIndex].IsStepComplete;

    public void GoToStep(int step)
    {
        if (step < 0 || step >= steps.Count)
        {
            return;
        }
        while (currentStepIndex < step)
        {
            if (!NextStep())
            {
                break;
            }
        }
        if (currentStepIndex > step)
        {
            currentStepIndex = step;
            RenderStep();
        }
    }

    private bool NextStep()
    {
        if (IsStepComplete)
        {
            currentStepIndex++;
            RenderStep();
            return true;
        }
        return false;
    }

    private void PreviousStep()
    {
        currentStepIndex--;
        RenderStep();
    }

    private void RenderStep()
    {
        var currentStep = steps[currentStepIndex];
        ContentArea = currentStep.ChildContent;
        StateHasChanged();
    }

    public void AddStep(Step step)
    {
        steps.Add(step);
        if (currentStepIndex == steps.Count - 1)
        {
            RenderStep();
        }
        StateHasChanged();
    }

    public void Refresh()
    {
        StateHasChanged();
    }
}
