@typeparam TData
@inject WindowService WindowService

@if (isShowing)
{
    <div class="@dragClass b-cursor-grab" draggable="true" 
        @ondragend="HandleDragEnd" 
        @ondragstart="HandleDragStart"
        @ontouchstart="HandleTouchStart"
        @ontouchmove="HandleTouchStart"
        @ontouchend="HandleTouchEnd" 
        @ontouchcancel="HandleTouchEnd">
        @ChildContent
    </div>
}

@code {
    [CascadingParameter] public DragContext<TData>? Context { get; set; }
    [CascadingParameter] public DropArea<TData>? DropArea { get; set; }

    [Parameter] public TData? DragData { get; set; }
    [Parameter] public RenderFragment? ChildContent { get; set; }
    [Parameter] public bool Copy { get; set; } = false;

    private string dragClass => isDragging ? "b-opacity-50" : string.Empty;
    private bool isShowing = true;
    private bool isDragging = false;
    private bool droppedInDropZone = false;

    public void OnDragToDropZoneComplete()
    {
        droppedInDropZone = true;
    }

    private async Task HandleDragEnd(DragEventArgs e)
    {
        await EndDrag();
    }
    private async Task HandleTouchEnd(TouchEventArgs e)
    {
        await WindowService.EnableTouchScroll();
        await EndDrag(true, e);
    }

    private async Task EndDrag(bool isTouch = false, TouchEventArgs? e = null)
    {
        if (Context is not null)
        {
            if (isTouch && e != null)
            {
                await Context.OnTouchEnd(e);
            }
            Context.OnDragStop();
        }

        if (!Copy && droppedInDropZone)
        {
            if (DragData is not null && DropArea is not null)
            {
                DropArea.RemoveDragItem(DragData);
            }
            else 
            {
                isShowing = false;
            }
        }

        isDragging = false;        
        StateHasChanged();
    }

    private async Task HandleTouchStart(TouchEventArgs e)
    {
        await WindowService.DisableTouchScroll();
        await StartDrag();
    }

    private async Task HandleDragStart(DragEventArgs e)
    {
        await StartDrag();
    }

    private async Task StartDrag()
    {
        droppedInDropZone = false;
        isDragging = true;
        StateHasChanged();
        if (Context is not null)
        {
            await Context.OnDragStart(this);
        }
    }
}